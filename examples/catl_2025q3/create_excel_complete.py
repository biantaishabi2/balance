#!/usr/bin/env python3
"""创建宁德时代2025Q3完整财务报表Excel（从PDF OCR提取的数据）"""

from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, PatternFill
from openpyxl.utils import get_column_letter

wb = Workbook()

# 样式
header_fill = PatternFill(start_color="CCE5FF", end_color="CCE5FF", fill_type="solid")
bold_font = Font(bold=True)

# ========== 资产负债表 ==========
ws_bs = wb.active
ws_bs.title = "资产负债表"

# 表头
ws_bs['A1'] = "宁德时代2025年第三季度 - 合并资产负债表"
ws_bs['A1'].font = Font(bold=True, size=14)
ws_bs.merge_cells('A1:C1')

ws_bs['A2'] = "单位：千元"
ws_bs['A3'] = "项目"
ws_bs['B3'] = "期末余额(2025-09-30)"
ws_bs['C3'] = "期初余额(2024-12-31)"

# 从PDF OCR提取的资产负债表数据
data_bs = [
    ("流动资产：", "", ""),
    ("货币资金", 324241586, 303511993),
    ("交易性金融资产", 43260528, 14282253),
    ("应收票据", 418837, 130403),
    ("应收账款", 66481235, 64135510),
    ("应收款项融资", 32082832, 53309701),
    ("预付款项", 13557167, 5969685),
    ("其他应收款", 2862290, 2206947),
    ("存货", 80211558, 59835533),
    ("合同资产", 398446, 400626),
    ("一年内到期的非流动资产", 98616, 72972),
    ("其他流动资产", 10578550, 6286465),
    ("流动资产合计", 574228137, 510142089),
    ("", "", ""),
    ("非流动资产：", "", ""),
    ("长期应收款", 193099, 151342),
    ("长期股权投资", 59831799, 54791525),
    ("其他权益工具投资", 17041260, 11900901),
    ("其他非流动金融资产", 3464955, 3135658),
    ("固定资产", 128622702, 118696651),  # 从第7页
    ("在建工程", None, None),  # 待补充
    ("无形资产", 15025388, 14684829),
    ("商誉", None, None),
    ("递延所得税资产", None, None),
    ("其他非流动资产", None, None),
    ("非流动资产合计", 321853995, 276516034),
    ("", "", ""),
    ("资产总计", 896082131, 786658123),
    ("", "", ""),
    ("流动负债：", "", ""),
    ("短期借款", 15314463, None),
    ("应付票据", None, None),
    ("应付账款", None, None),
    ("合同负债", None, None),
    ("应付职工薪酬", None, None),
    ("应交税费", None, None),
    ("其他应付款", None, None),
    ("一年内到期的非流动负债", None, None),
    ("其他流动负债", None, None),
    ("流动负债合计", 340940328, 317171534),
    ("", "", ""),
    ("非流动负债：", "", ""),
    ("长期借款", 78441925, None),
    ("租赁负债", 1677863, 662814),
    ("长期应付款", 1519965, 1606480),
    ("预计负债", 85843047, 71926943),
    ("递延收益", 25224182, 22041069),
    ("递延所得税负债", 2261098, 1231236),
    ("其他非流动负债", 4739536, 5400795),
    ("非流动负债合计", 208129732, 196030416),
    ("", "", ""),
    ("负债合计", 549070060, 513201949),
    ("", "", ""),
    ("所有者权益：", "", ""),
    ("股本", 4562854, 4403466),
    ("资本公积", 156365576, 116756136),
    ("减：库存股", 7097993, 2712804),
    ("其他综合收益", 6391356, -348637),
    ("专项储备", 38434, 35551),
    ("盈余公积", 2272701, 2194779),
    ("未分配利润", 151715049, 126601541),
    ("归属于母公司所有者权益合计", 314247976, 246930033),
    ("少数股东权益", 32764095, 26526141),
    ("所有者权益合计", 347012071, 273456174),
    ("", "", ""),
    ("负债和所有者权益总计", 896082131, 786658123),
]

for i, (name, end_val, begin_val) in enumerate(data_bs, start=4):
    ws_bs[f'A{i}'] = name
    if end_val is not None and end_val != "":
        ws_bs[f'B{i}'] = end_val
    if begin_val is not None and begin_val != "":
        ws_bs[f'C{i}'] = begin_val
    # 加粗合计行
    if "合计" in name or "总计" in name:
        ws_bs[f'A{i}'].font = bold_font
        ws_bs[f'B{i}'].font = bold_font
        ws_bs[f'C{i}'].font = bold_font

ws_bs.column_dimensions['A'].width = 35
ws_bs.column_dimensions['B'].width = 22
ws_bs.column_dimensions['C'].width = 22

# ========== 利润表 ==========
ws_pl = wb.create_sheet("利润表")

ws_pl['A1'] = "宁德时代2025年第三季度 - 合并利润表"
ws_pl['A1'].font = Font(bold=True, size=14)
ws_pl.merge_cells('A1:C1')

ws_pl['A2'] = "单位：千元"
ws_pl['A3'] = "项目"
ws_pl['B3'] = "本期发生额(2025年1-9月)"
ws_pl['C3'] = "上期发生额(2024年1-9月)"

# 从PDF OCR提取的利润表数据
data_pl = [
    ("一、营业总收入", 283071987, 259044749),
    ("其中：营业收入", 283071987, 259044749),
    ("", "", ""),
    ("二、营业总成本", 231962490, 215471465),
    ("其中：营业成本", 211427147, 194352589),
    ("税金及附加", 1843066, 1557474),
    ("销售费用", 2408522, 2608019),
    ("管理费用", 8231715, 6774456),
    ("研发费用", 15067826, 13073136),
    ("财务费用", -7015786, -2894209),
    ("其中：利息费用", 2183477, 2966060),
    ("利息收入", 8060682, 7126536),
    ("", "", ""),
    ("加：其他收益", 7693237, 6730726),
    ("投资收益", 5236818, 3127167),
    ("其中：对联营企业和合营企业的投资收益", 4943750, 2712745),
    ("公允价值变动收益", 878537, 190410),
    ("信用减值损失", -377141, -891718),
    ("资产减值损失", -4077847, -6651709),
    ("资产处置收益", 89212, 47590),
    ("", "", ""),
    ("三、营业利润", 60552312, 46125750),
    ("加：营业外收入", 372284, 142604),
    ("减：营业外支出", 212195, 547867),
    ("", "", ""),
    ("四、利润总额", 60712402, 45720486),
    ("减：所得税费用", 8415535, 6987231),
    ("", "", ""),
    ("五、净利润", 52296866, 38733255),
    ("（一）持续经营净利润", 52296866, 38733255),
    ("（二）终止经营净利润", None, None),
    ("", "", ""),
    ("归属于母公司股东的净利润", 49034109, 36001074),
    ("少数股东损益", 3262757, 2732181),
    ("", "", ""),
    ("六、其他综合收益的税后净额", 7455238, -568007),
    ("", "", ""),
    ("七、综合收益总额", 59752104, 38165248),
    ("归属于母公司所有者的综合收益总额", 56472049, 35252110),
    ("归属于少数股东的综合收益总额", 3280055, 2913138),
    ("", "", ""),
    ("八、每股收益：", "", ""),
    ("基本每股收益（元/股）", 11.02, 8.19),
    ("稀释每股收益（元/股）", 11.02, 8.18),
]

for i, (name, cur_val, prev_val) in enumerate(data_pl, start=4):
    ws_pl[f'A{i}'] = name
    if cur_val is not None and cur_val != "":
        ws_pl[f'B{i}'] = cur_val
    if prev_val is not None and prev_val != "":
        ws_pl[f'C{i}'] = prev_val
    # 加粗重要行
    if name.startswith(("一、", "二、", "三、", "四、", "五、", "六、", "七、")):
        ws_pl[f'A{i}'].font = bold_font

ws_pl.column_dimensions['A'].width = 40
ws_pl.column_dimensions['B'].width = 25
ws_pl.column_dimensions['C'].width = 25

# ========== 现金流量表 ==========
ws_cf = wb.create_sheet("现金流量表")

ws_cf['A1'] = "宁德时代2025年第三季度 - 合并现金流量表"
ws_cf['A1'].font = Font(bold=True, size=14)
ws_cf.merge_cells('A1:C1')

ws_cf['A2'] = "单位：千元"
ws_cf['A3'] = "项目"
ws_cf['B3'] = "本期发生额(2025年1-9月)"
ws_cf['C3'] = "上期发生额(2024年1-9月)"

# 从PDF OCR提取的现金流量表数据
data_cf = [
    ("一、经营活动产生的现金流量：", "", ""),
    ("经营活动现金流入小计", None, None),
    ("经营活动现金流出小计", None, None),
    ("经营活动产生的现金流量净额", 80660430, 67441601),
    ("", "", ""),
    ("二、投资活动产生的现金流量：", "", ""),
    ("投资活动现金流入小计", None, None),
    ("投资活动现金流出小计", 63792799, 50460297),
    ("投资活动产生的现金流量净额", -57291490, -47894482),
    ("", "", ""),
    ("三、筹资活动产生的现金流量：", "", ""),
    ("吸收投资收到的现金", 43272406, 1910761),
    ("其中：子公司吸收少数股东投资收到的现金", 5488866, 1488074),
    ("取得借款收到的现金", 30597681, 17823561),
    ("收到其他与筹资活动有关的现金", 1125480, None),
    ("筹资活动现金流入小计", 74995566, 19734322),
    ("偿还债务支付的现金", 32237114, 13951582),
    ("分配股利、利润或偿付利息支付的现金", 33558798, 24858846),
    ("其中：子公司支付给少数股东的股利、利润", 1714326, 496051),
    ("支付其他与筹资活动有关的现金", 4923115, 1419577),
    ("筹资活动现金流出小计", 70719026, 40230005),
    ("筹资活动产生的现金流量净额", 4276539, -20495683),
    ("", "", ""),
    ("四、汇率变动对现金及现金等价物的影响", -621254, -2265020),
    ("", "", ""),
    ("五、现金及现金等价物净增加额", 27024225, -3211583),
    ("加：期初现金及现金等价物余额", 270159734, 238165487),
    ("六、期末现金及现金等价物余额", 297183959, 234953904),
]

for i, (name, cur_val, prev_val) in enumerate(data_cf, start=4):
    ws_cf[f'A{i}'] = name
    if cur_val is not None and cur_val != "":
        ws_cf[f'B{i}'] = cur_val
    if prev_val is not None and prev_val != "":
        ws_cf[f'C{i}'] = prev_val
    # 加粗大类
    if name.startswith(("一、", "二、", "三、", "四、", "五、", "六、")):
        ws_cf[f'A{i}'].font = bold_font

ws_cf.column_dimensions['A'].width = 45
ws_cf.column_dimensions['B'].width = 25
ws_cf.column_dimensions['C'].width = 25

# ========== 配平工具输入格式 ==========
ws_input = wb.create_sheet("配平工具输入")

ws_input['A1'] = "配平工具标准输入格式"
ws_input['A1'].font = Font(bold=True, size=14)

ws_input['A3'] = "字段名"
ws_input['B3'] = "值（千元转万元）"
ws_input['C3'] = "说明"

# 转换为配平工具需要的格式（千元转万元，除以10）
input_data = [
    ("revenue", 28307198.70, "营业收入"),
    ("cost", 21142714.70, "营业成本"),
    ("other_expense", 2640875.30, "税金+销售+管理+研发费用合计"),
    ("interest_expense", 218347.70, "利息费用"),
    ("interest_income", 806068.20, "利息收入"),
    ("tax", 841553.50, "所得税费用"),
    ("net_income", 5229686.60, "净利润"),
    ("", "", ""),
    ("opening_cash", 30351199.30, "期初货币资金"),
    ("closing_cash", 32424158.60, "期末货币资金"),
    ("", "", ""),
    ("opening_receivable", 6413551.00, "期初应收账款"),
    ("closing_receivable", 6648123.50, "期末应收账款"),
    ("", "", ""),
    ("opening_inventory", 5983553.30, "期初存货"),
    ("closing_inventory", 8021155.80, "期末存货"),
    ("", "", ""),
    ("opening_fixed_asset", 11869665.10, "期初固定资产"),
    ("closing_fixed_asset", 12862270.20, "期末固定资产"),
    ("", "", ""),
    ("opening_debt", None, "期初借款（短期+长期）"),
    ("closing_debt", 9375638.80, "期末借款（短期+长期）"),
    ("", "", ""),
    ("opening_equity", 27345617.40, "期初股东权益"),
    ("closing_equity", 34701207.10, "期末股东权益"),
    ("", "", ""),
    ("operating_cashflow", 8066043.00, "经营活动现金流量净额"),
    ("investing_cashflow", -5729149.00, "投资活动现金流量净额"),
    ("financing_cashflow", 427653.90, "筹资活动现金流量净额"),
]

for i, (field, value, desc) in enumerate(input_data, start=4):
    ws_input[f'A{i}'] = field
    if value is not None:
        ws_input[f'B{i}'] = value
    ws_input[f'C{i}'] = desc

ws_input.column_dimensions['A'].width = 25
ws_input.column_dimensions['B'].width = 18
ws_input.column_dimensions['C'].width = 35

# 保存
output_path = "/home/wangbo/document/balance/examples/catl_2025q3/catl_2025q3_complete.xlsx"
wb.save(output_path)
print(f"完整Excel已保存到: {output_path}")
