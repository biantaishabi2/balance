# 宁德时代财务三表模型分析任务

## 任务目标

基于宁德时代（股票代码：300750）最新季报，构建完整的财务三表模型，并进行预测分析。

---

## Acceptance Criteria（验收标准）

### AC-1: 数据获取
- [ ] 从巨潮资讯网或官方渠道下载宁德时代最新季度报告 PDF
- [ ] 使用 PaddleOCR 解析 PDF，提取完整的财务三表数据
- [ ] 将提取的数据整理为 Excel 文件，包含：
  - 资产负债表（期末/期初）
  - 利润表（本期/上期）
  - 现金流量表（本期/上期）

### AC-2: 三表模型构建
- [ ] 使用 `excel2json` 提取数据为标准 JSON 格式
- [ ] 使用 `balance calc` 构建基础三表模型
- [ ] 确保模型包含以下核心计算：
  - 毛利 = 营业收入 - 营业成本
  - 净利润 = 利润总额 - 所得税
  - 经营现金流 = 净利润 + 折旧 ± 营运资本变动
  - 资产 = 负债 + 股东权益

### AC-3: 三种情景预测
- [ ] **基准情景（Base Case）**：维持当前增长趋势
  - 收入增长率：按历史平均增速
  - 毛利率：维持当前水平
  - 费用率：维持当前水平

- [ ] **乐观情景（Bull Case）**：高增长假设
  - 收入增长率：+15%（储能市场爆发）
  - 毛利率：提升 2%（规模效应）
  - 研发费用率：维持

- [ ] **悲观情景（Bear Case）**：保守假设
  - 收入增长率：+5%（市场竞争加剧）
  - 毛利率：下降 2%（价格战）
  - 应收账款周转天数：延长

- [ ] 使用 `balance scenario` 生成三种情景对比表

### AC-4: 输出报告
- [ ] 生成完整的分析报告，包含：
  - 数据来源说明
  - 三表模型概览
  - 三种情景预测结果对比
  - 关键财务指标分析（毛利率、净利率、ROE、负债率）
  - 投资建议（基于模型结果）

---

## V&V Criteria（验证与确认标准）

### VV-1: 资产负债表配平检验
```
验证公式：资产总计 = 负债合计 + 股东权益合计
容差范围：|差额| < 1（千元级别四舍五入误差）
```

**检验方法**：
```bash
balance diagnose < output.json | grep "is_balanced"
# 期望结果：is_balanced: true
```

### VV-2: 现金流量表配平检验
```
验证公式：期末现金 = 期初现金 + 经营现金流 + 投资现金流 + 筹资现金流 + 汇率影响
容差范围：|差额| < 10（千元级别）
```

**检验方法**：
```bash
# 计算现金变动
Δ现金 = closing_cash - opening_cash
现金流合计 = operating_cashflow + investing_cashflow + financing_cashflow
# 验证：Δ现金 ≈ 现金流合计
```

### VV-3: 勾稽关系随机抽查（至少验证 5 项）

| # | 勾稽关系 | 验证公式 | 通过标准 |
|---|---------|---------|---------|
| 1 | 毛利计算 | `gross_profit = revenue - cost` | 完全相等 |
| 2 | 净利润勾稽 | `net_income = ebt - tax` | 完全相等 |
| 3 | 留存收益变动 | `Δ留存收益 = 净利润 - 分红` | 差额 < 1% |
| 4 | 折旧勾稽 | `Δ累计折旧 = 本期折旧费用` | 完全相等 |
| 5 | 借款变动 | `Δ借款 = 新增借款 - 偿还借款` | 差额 < 1% |
| 6 | 利息费用 | `利息费用 ≈ 平均借款 × 利率` | 差额 < 5% |
| 7 | 所得税率 | `税率 = 所得税 / 利润总额` | 15%-25% 合理范围 |

**检验方法**：
```bash
balance diagnose < output.json
# 查看 delta_table 中每项的 match 状态
```

### VV-4: 情景分析合理性检验
```
验证条件：
1. 乐观情景净利润 > 基准情景净利润 > 悲观情景净利润
2. 三种情景均能配平（is_balanced: true）
3. 各情景毛利率在 20%-35% 合理范围内
```

---

## 执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│ Phase 1: 数据获取                                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. WebSearch 搜索宁德时代最新季报                                 │
│ 2. curl 下载 PDF 到 examples/catl_2025q3/                        │
│ 3. pdftoppm 转换 PDF 为图片                                      │
│ 4. paddleocr.sh 识别财务报表数据                                  │
│ 5. 生成 catl_2025qX_complete.xlsx                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 2: 模型构建                                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. excel2json catl_2025qX_complete.xlsx > input.json             │
│ 2. balance check < input.json                                    │
│ 3. balance calc < input.json > output.json                       │
│ 4. balance diagnose < output.json  # VV-1, VV-2, VV-3            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 3: 情景预测                                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. 创建 base_case.json, bull_case.json, bear_case.json           │
│ 2. balance scenario 对比三种情景                                  │
│ 3. 验证 VV-4：情景合理性                                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│ Phase 4: 报告生成                                                │
├─────────────────────────────────────────────────────────────────┤
│ 1. 生成 REPORT.md 分析报告                                        │
│ 2. 包含 V&V 检验结果                                              │
│ 3. 包含三种情景对比表                                             │
│ 4. 给出投资建议                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 工具依赖

| 工具 | 用途 | 路径 |
|------|------|------|
| PaddleOCR | PDF 表格识别 | `/home/wangbo/document/zcpg/scripts/paddleocr.sh` |
| pdftoppm | PDF 转图片 | 系统命令 |
| balance | 三表配平计算 | `/home/wangbo/document/balance/balance.py` |
| excel2json | Excel 提取 | `/home/wangbo/document/balance/excel2json.py` |
| json2excel | 写回 Excel | `/home/wangbo/document/balance/json2excel.py` |

---

## 预期产出物

```
examples/catl_2025q3/
├── catl_2025q3_report.pdf          # 原始季报 PDF
├── catl_2025q3_complete.xlsx       # 完整财务数据 Excel
├── input.json                      # 配平工具输入
├── output.json                     # 配平计算结果
├── base_case.json                  # 基准情景
├── bull_case.json                  # 乐观情景
├── bear_case.json                  # 悲观情景
├── scenario_comparison.json        # 情景对比结果
├── vv_report.md                    # V&V 检验报告
└── REPORT.md                       # 完整分析报告
```

---

## 签收标准

任务完成需同时满足：

1. ✅ 所有 AC（验收标准）全部勾选完成
2. ✅ 所有 VV（验证标准）检验通过
3. ✅ 生成完整的分析报告 REPORT.md
4. ✅ 三种情景预测结果合理且可解释
