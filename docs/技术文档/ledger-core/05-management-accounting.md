# 管理会计与成本（详细设计/测试合一）

## Overview
在现有记账与维度基础上补齐成本中心、分摊规则与预算控制，形成管理会计闭环。

## Workflow Type
feature

## Task Scope

**In scope**：
- 成本中心/项目维度成本归集
- 分摊规则与分摊凭证
- 预算控制（占用/释放/冻结）
- 预算-实际差异分析

**Out of scope**：
- 经营预测与复杂绩效模型
- 战略预算与多版本预测

## 目标
- 成本可按维度归集与分摊
- 预算可控制并形成差异闭环

## 当前问题（需要解决）
- 成本只在总账，缺少分摊
- 无预算口径与控制流程

## 核心设计

### 1. 成本中心与归集
- 复用现有维度（department/project）作为成本中心
- 分录支持成本中心维度写入

### 2. 分摊规则
- `allocation_rules`：
  - `id, name, source_accounts, target_dim, basis, period`
- `basis`：收入、人工、面积、固定比例等
- 运行分摊生成“分摊凭证”
- 分摊明细：
  - `allocation_rule_lines(rule_id, target_dim_id, ratio)`
  - `ratio` 仅用于固定比例，其余口径由基础数据计算
- 基础数据来源：
  - 收入：按期间汇总收入科目发生额
  - 人工：`allocation_basis_values(period, dim_id, value)` 维护人数
  - 面积：`allocation_basis_values(period, dim_id, value)` 维护面积
  - 计算公式：目标比重 = 目标指标值 / 指标值合计

### 3. 预算控制
- `budgets`：
  - `id, period, dim_type, dim_id, amount`
- `budget_controls`：
  - `id, period, dim_type, dim_id, used_amount, locked_amount`
- 录入费用类凭证时占用预算，超额时提示或阻断

### 4. 预算-实际差异
- 汇总实际发生额与预算差异
- 支持按期间与维度查询

## 方案差异（相对现状）
- 从“仅总账”升级为“成本中心可分摊与预算闭环”

## 落地步骤与测试（统一版）

0. **成本中心与分摊规则（待做）**
   - 做什么：新增分摊规则与分摊凭证
   - 测试：分摊金额与规则一致

1. **预算控制（待做）**
   - 做什么：预算表与占用逻辑
   - 测试：超额提示或阻断

2. **差异分析（待做）**
   - 做什么：预算-实际报表
   - 测试：差异金额准确

## 可执行测试用例

### 测试环境准备
```bash
rm -f /tmp/ledger_mgmt.db
ledger init --db-path /tmp/ledger_mgmt.db
```

### TC-MA-01: 成本分摊
- **操作**：
  1) 成本池科目=“管理费用”，金额 1,000
  2) 分摊口径=收入
  3) 部门 A 收入 3,000，部门 B 收入 1,000
- **预期**：
  - 分摊比例 A:75%，B:25%
  - 分摊凭证：借“管理费用(A)”750，借“管理费用(B)”250，贷“管理费用(成本池)”1,000

### TC-MA-02: 预算占用
- **操作**：
  1) 部门 A 预算 500
  2) 录入费用凭证 600
- **预期**：
  - 阻断模式：返回“超预算”错误
  - 提示模式：返回“超预算”提示但允许保存

### TC-MA-03: 差异分析
- **操作**：
  1) 部门 A 预算 1,000
  2) 实际发生 800
- **预期**：
  - 差异 = 200（预算 - 实际）

## 备注
- 预算控制策略可配置（提示/阻断）
