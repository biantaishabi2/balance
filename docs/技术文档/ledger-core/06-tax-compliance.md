# 合规与税务（详细设计/测试合一）

## Overview
在现有记账与报表基础上补齐发票/税控、税会差异与税务报表口径，形成合规闭环。

## Workflow Type
feature

## Task Scope

**In scope**：
- 发票档案与税控联动（销项/进项）
- 增值税与所得税计算口径
- 税会差异与递延税
- 税务报表输出（基础口径）

**Out of scope**：
- 复杂税务筹划
- 多准则多账簿

## 目标
- 发票与账务联动
- 税会差异可追踪
- 税务报表可导出

## 当前问题（需要解决）
- 无发票与税控对接
- 缺少税会差异与递延税

## 核心设计

### 1. 发票与税控
- `invoices`：
  - `id, type, code, number, date, amount, tax_amount, status`
- 发票与凭证关联

### 2. 增值税口径
- 按销项/进项汇总税额
- 生成应交税金凭证

### 3. 税会差异与递延税
- `tax_adjustments`：
  - `period, adjustment_type, amount, voucher_id`
- 支持临时性差异与递延税

### 4. 税务报表
- 输出 VAT、所得税基础报表

## 方案差异（相对现状）
- 从“无税务联动”升级为“税务闭环”

## 落地步骤与测试（统一版）

0. **发票表与联动（待做）**
   - 做什么：发票档案 + 凭证关联
   - 测试：发票与凭证一致

1. **税额计算（待做）**
   - 做什么：销项/进项税额汇总
   - 测试：税额与凭证一致

2. **税会差异（待做）**
   - 做什么：税会差异与递延税
   - 测试：差异凭证生成

## 可执行测试用例

### 测试环境准备
```bash
rm -f /tmp/ledger_tax.db
ledger init --db-path /tmp/ledger_tax.db
```

### TC-TAX-01: 发票关联
- **操作**：录入发票与凭证
- **预期**：发票与凭证匹配

### TC-TAX-02: 税额汇总
- **操作**：输出 VAT 报表
- **预期**：税额正确

### TC-TAX-03: 税会差异
- **操作**：录入差异并生成凭证
- **预期**：差异金额正确

## 备注
- 税控接口先预留占位，不做真实对接
