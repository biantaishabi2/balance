# 合规与税务（详细设计/测试合一）

## Overview
在现有记账与报表基础上补齐发票/税控、税会差异与税务报表口径，形成合规闭环。

## Workflow Type
feature

## Task Scope

**In scope**：
- 发票档案与税控联动（销项/进项）
- 增值税与所得税计算口径
- 税会差异与递延税
- 税务报表输出（基础口径）

**Out of scope**：
- 复杂税务筹划
- 多准则多账簿

## 目标
- 发票与账务联动
- 税会差异可追踪
- 税务报表可导出

## 当前问题（需要解决）
- 无发票与税控对接
- 缺少税会差异与递延税

## 核心设计

### 1. 发票与税控
- `invoices`：
  - `id, type, code, number, date, amount, tax_amount, status`
- 发票与凭证关联

### 2. 增值税口径
- 按销项/进项汇总税额
- 生成应交税金凭证
- 科目映射：
  - 销项税额：`应交税费-应交增值税(销项税额)`
  - 进项税额：`应交税费-应交增值税(进项税额)`
  - 未交增值税：`应交税费-应交增值税(未交增值税)`

### 3. 税会差异与递延税
- `tax_adjustments`：
  - `period, adjustment_type, amount, voucher_id`
- 支持临时性差异与递延税

### 4. 税务报表
- 输出 VAT、所得税基础报表

## 方案差异（相对现状）
- 从“无税务联动”升级为“税务闭环”

## 落地步骤与测试（统一版）

0. **发票表与联动（待做）**
   - 做什么：发票档案 + 凭证关联
   - 测试：发票与凭证一致

1. **税额计算（待做）**
   - 做什么：销项/进项税额汇总
   - 测试：税额与凭证一致

2. **税会差异（待做）**
   - 做什么：税会差异与递延税
   - 测试：差异凭证生成

## 可执行测试用例

### 测试环境准备
```bash
rm -f /tmp/ledger_tax.db
ledger init --db-path /tmp/ledger_tax.db
```

### TC-TAX-01: 发票关联
- **操作**：
  1) 销售发票：不含税金额 1,000，税率 13%
  2) 采购发票：不含税金额 500，税率 13%
- **预期**：
  - 销项税额 130，进项税额 65
  - 发票与对应凭证关联一致

### TC-TAX-02: 税额汇总
- **操作**：期末汇总 VAT
- **预期**：
  - 净应交增值税 = 130 - 65 = 65
  - 期末凭证：借“销项税额”130，贷“进项税额”65，贷“未交增值税”65

### TC-TAX-03: 税会差异
- **操作**：
  1) 计提所得税：税前利润 2,000，税率 25%
  2) 录入一笔不可税前扣除费用 100
- **预期**：
  - 所得税费用=500，凭证：借“所得税费用”500，贷“应交所得税”500
  - 税会差异记录金额 100，差异类型=永久性差异

## 备注
- 税控接口先预留占位，不做真实对接
