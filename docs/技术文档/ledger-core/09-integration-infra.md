# 集成与基础设施（详细设计/测试合一）

## Overview
为记账系统提供对外系统集成、组织多租户支持与性能归档能力，支撑生产级使用。

## Workflow Type
feature

## Task Scope

**In scope**：
- 对外接口（API/消息）
- 组织与多租户模型
- 性能与历史归档

**Out of scope**：
- 大数据平台与实时数仓
- UI 网关

## 目标
- 业务系统可稳定接入
- 多组织账套隔离
- 大数据量下可持续运行

## 当前问题（需要解决）
- 无标准 API
- 无多租户模型
- 大账套性能与归档缺失

## 核心设计

### 1. API 与消息集成
- REST API + Webhook 事件
- 关键事件：凭证生成、结账、子账变动

### 2. 组织与多租户
- `tenants`：租户表
- `organizations`：组织结构
- 账套与租户绑定
- 关键表强制包含 `tenant_id` / `org_id`
- 查询必须带租户条件，唯一约束需包含 `tenant_id`
- 认证令牌携带 `tenant_id`/`org_id`，跨租户访问返回 404/403

### 3. 性能与归档
- 大表分区或归档策略
- 查询索引优化与冷热分层

## 方案差异（相对现状）
- 从“单机单账套”升级为“可集成、可扩展”

## 落地步骤与测试（统一版）

0. **API 草案（待做）**
   - 做什么：定义 API 与认证
   - 测试：API 可调用

1. **多租户（待做）**
   - 做什么：租户/组织模型
   - 测试：账套隔离

2. **归档与性能（待做）**
   - 做什么：归档策略与索引
   - 测试：历史数据归档查询

## 可执行测试用例

### 测试环境准备
```bash
rm -f /tmp/ledger_infra.db
ledger init --db-path /tmp/ledger_infra.db
```

### TC-INFRA-01: API 接口
- **操作**：调用 API 创建凭证
- **预期**：返回成功

### TC-INFRA-02: 多租户隔离
- **操作**：
  1) 租户 A 创建凭证 VA-001
  2) 租户 B 使用自身 token 读取 VA-001
- **预期**：
  - 返回 404/403
  - 审计日志记录跨租户访问尝试

### TC-INFRA-03: 归档查询
- **操作**：归档后查询历史凭证
- **预期**：结果可读

## 备注
- API 认证先用 token 占位
