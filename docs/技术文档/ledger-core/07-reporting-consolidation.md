# 报表与合并（详细设计/测试合一）

## Overview
在现有三表基础上补齐多账套合并、抵销与自定义报表能力，形成集团层报表输出。

## Workflow Type
feature

## Task Scope

**In scope**：
- 多账套/多公司合并
- 内部交易抵销
- 自定义报表模板
- 合并报表输出

**Out of scope**：
- 复杂税务合并
- 全量 BI 平台

## 目标
- 支持多账套合并口径
- 抵销逻辑可配置
- 报表模板可复用

## 当前问题（需要解决）
- 仅支持单账套报表
- 无合并与抵销

## 核心设计

### 1. 账套与公司
- `companies`：`id, code, name, base_currency`
- `ledgers` 关联公司

### 2. 合并规则
- `consolidation_rules`：
  - `id, name, elimination_accounts, ownership`
- 根据权益比例进行合并

### 3. 抵销处理
- 内部往来、内部交易生成抵销分录
- 抵销凭证不回写子账

### 4. 报表模板
- `report_templates`：
  - `code, name, fields, formula`
- 输出合并报表

## 方案差异（相对现状）
- 从“单账套三表”升级为“合并报表”

## 落地步骤与测试（统一版）

0. **多账套与公司（待做）**
   - 做什么：新增公司/账套关系
   - 测试：多账套加载

1. **合并与抵销（待做）**
   - 做什么：抵销规则与合并输出
   - 测试：抵销后报表平衡

2. **模板化报表（待做）**
   - 做什么：模板设计与输出
   - 测试：模板字段正确

## 可执行测试用例

### 测试环境准备
```bash
rm -f /tmp/ledger_consolidation.db
```

### TC-CON-01: 多账套合并
- **操作**：加载多账套并合并
- **预期**：合并报表输出

### TC-CON-02: 抵销规则
- **操作**：配置抵销规则
- **预期**：内部交易抵销

### TC-CON-03: 模板报表
- **操作**：自定义模板输出
- **预期**：字段与公式正确

## 备注
- 合并口径初期仅支持全资或简单权益比例
