# 应收/应付深度能力（详细设计/测试合一）

## Overview
在现有应收/应付子账基础上补齐信用、票据、收付款计划与坏账计提，形成可控的往来管理闭环。

## Workflow Type
feature

## Task Scope

**In scope**：
- 客户/供应商信用额度与占用
- 收款/付款计划与回款跟踪
- 票据管理（承兑/背书/贴现）
- 坏账计提与冲回

**Out of scope**：
- 税控/发票联动
- 复杂资金管理（票据池、资金预测）

## 目标
- 往来风险可控，信用占用可追踪
- 收付款计划有可执行记录
- 坏账计提有明确口径与凭证

## 当前问题（已解决）
- 只有核销与余额，没有信用/账期管理
- 无收付款计划与回款跟踪
- 无坏账计提流程

## 核心设计

### 1. 信用管理
- `customers`/`suppliers` 扩展信用字段：
  - `credit_limit`、`credit_used`、`credit_days`
- 录入应收/应付时更新占用
- 超额时提示或阻断（可配置）

### 2. 收付款计划
- 新增 `payment_plans`：
  - `id, item_type, item_id, due_date, amount, status`
- 到期可标记已收/已付，并生成对应凭证

### 3. 票据管理
- 新增 `bills`：
  - `id, bill_no, bill_type, amount, status, maturity_date, item_type, item_id`
- 票据状态流转：持有 → 背书/贴现 → 结清
- 票据流转生成凭证
- 背书/贴现科目可配置（`bill_endorse_account`，默认银行存款）

### 4. 坏账计提
- 新增 `bad_debt_provisions`：
  - `period, customer_id, amount, voucher_id`
- 规则：按账龄比例或固定比例
- 计提/冲回生成凭证

### 5. 子账科目映射
- 子账与总账科目映射通过 `data/subledger_mapping.json` 配置
- AR/AP 关键键位：
  - `ar.ar_account` / `ar.revenue_account` / `ar.bank_account`
  - `ap.ap_account` / `ap.inventory_account` / `ap.bank_account`
- 允许按企业科目体系替换映射并影响自动凭证

## 方案差异（相对现状）
- 从“核销为主”升级为“信用+计划+票据+坏账”闭环

## 落地步骤与测试（统一版）

0. **信用字段与占用（已完成）**
   - 做什么：扩展客户/供应商字段
   - 测试：超额提示与占用更新

1. **收付款计划（已完成）**
   - 做什么：计划录入/到期处理
   - 测试：计划状态与凭证生成

2. **票据管理（已完成）**
   - 做什么：票据录入/背书/贴现
   - 测试：票据状态与凭证

3. **坏账计提（已完成）**
   - 做什么：账龄比例计提
   - 测试：计提/冲回凭证

4. **科目映射可配置（已完成）**
   - 做什么：通过 `subledger_mapping.json` 变更映射
   - 测试：自动凭证科目随映射变化

## 可执行测试用例

### 测试环境准备
```bash
rm -f /tmp/ledger_arap.db
ledger init --db-path /tmp/ledger_arap.db
```

### TC-ARAP-01: 信用额度占用
- **操作**：设置信用额度并录入应收
- **预期**：占用更新，超额提示

### TC-ARAP-02: 收款计划
- **操作**：录入计划并标记回款
- **预期**：状态更新且生成凭证

### TC-ARAP-03: 票据流转
- **操作**：录入票据 → 背书/贴现
- **预期**：票据状态与凭证正确

### TC-ARAP-04: 坏账计提
- **操作**：按账龄计提/冲回
- **预期**：坏账凭证与余额正确

### TC-ARAP-05: 映射配置生效
- **操作**：调整 AR/AP 映射科目后生成业务凭证
- **预期**：分录科目按新映射落账

## 备注
- 信用与票据规则可配置，默认仅提示不阻断
